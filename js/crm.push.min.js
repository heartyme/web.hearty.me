"use strict";function hj_update__push(e){return $.ajax({url:location.href,type:"POST",dataType:"json",data:e,async:!0,timeout:1e4})}function get_sent_stats(){hj_update__push({action:"get_sent_stats"}).then(function(e){e=e.Values,$("[data-sent_stats]").text(e.date+" 午夜起，已寄給 "+numberWithCommas(e.users_sent||0)+"人，共 "+numberWithCommas(e.pushs_sent||0)+"則")})}function get_recipients(){let e=$(".recipients"),t=parseInt($("input[name='uid_selection']:checked").val()||0),a=["iPhone","iPad","Android","手機網頁","電腦版"],i=$("input[name='device']:checked").map(function(){return parseInt(this.value)}).get().sort(),n=$("input[data-uid_interval]").map(function(){return parseInt(this.value||1)}).get().sort(),l=$("textarea[data-uid_listed]").val().split(",").map(function(e){return parseInt(e.trim())||1}).sort();if(e.slideUp("fast"),$(".recipient_data .result").empty(),n[1]-n[0]>1e5){msg('<i class="far fa-exclamation-triangle"></i> 考量查詢量能，避免一次選擇超過 10萬位用戶');return}hj_loading(!0),hj_update__push({action:"get_recipients",uid_interval:0==t?JSON.stringify(n):"",uid_listed:1==t?JSON.stringify(l):"",device:JSON.stringify(i)}).then(function(t){switch(t.Status){case 1:for(let i in t=t.Values,e.empty(),t){let n=t[i];for(let l in n.tokens){let s=a[parseInt(n.tokens[l].device)],r=parseInt(n.tokens[l].fcm_id),c=parseInt(n.tokens[l].sent_today);$("<li>",{onclick:c>0?"alertify.error('* 略過重複 #"+r+"')":"send_push(false, $(this));",title:n.username+" - "+s+" # "+r,"data-username":n.username,"data-nickname":n.nickname,"data-fcm_id":r,"data-fcmtoken":n.tokens[l].fcmtoken,"data-device":n.tokens[l].device,"data-sent_today":c}).appendTo(e)}}e.slideDown("fast",function(){$(window).scrollTop(e.get(0).offsetTop-50)});break;case 2:e.show(),msg('<i class="far fa-exclamation-triangle"></i> 資料漏填，或未選任何裝置')}}).fail(function(e){msg('<i class="far fa-exclamation-triangle"></i> 出錯了：<br>'+JSON.stringify(e))}).always(function(){hj_loading(!1)})}function send_push(e,t){if(e=e||!1,!(t=null==t?$(".recipients li[data-sent_today='0']:first"):t).length)return!1;let a=t.get(0).dataset,i=$(".push_data"),n={title:(i.find("[data-title]").val()||"").trim(),body:(i.find("[data-body]").val()||"").trim(),url:(i.find("[data-url]").val()||"https://hearty.me").trim(),tag:(i.find("[data-tag]").val()||"hj-default").trim(),device:Number(a.device||0),fcm_id:Number(a.fcm_id||0),fcmtoken:(a.fcmtoken||"").trim(),username:(a.username||"").trim(),nickname:(a.nickname||"").trim()};if(n.title.length<2||n.body.length<4)return msg('<i class="far fa-exclamation-triangle"></i> 請填寫推播訊息'),!1;n.title=n.title.replace(/\{{username}}/g,n.username).replace(/\{{nickname}}/g,n.nickname),n.body=n.body.replace(/\{{username}}/g,n.username).replace(/\{{nickname}}/g,n.nickname),n.url=n.url.replace(/\{{username}}/g,n.username),e?send_push_exec(n,e,t):(alertify.set({labels:{ok:"取消",cancel:'<i class="fas fa-inbox-out"></i> 發送'},buttonReverse:!1}),alertify.confirm('<i class="far fa-comment-lines"></i> 即將推播予：'+n.nickname+" ("+n.username+"，# "+numberWithCommas(n.fcm_id)+")",function(a){a||send_push_exec(n,e,t)}))}function send_push_exec(e,t,a){hj_update__push({action:"send_push",push:JSON.stringify(e)}).then(function(i){let n=i.Values;switch(i.Status){case 1:console.log(JSON.stringify(i));break;case 3:alertify.error('<i class="fas fa-exclamation-triangle"></i> 略過重複：'+e.username+" (# "+numberWithCommas(e.fcm_id)+")");break;default:"error"in n&&404==n.error.code?hj_update__push({action:"revoke_fcmtoken",fcmtoken:e.fcmtoken}).then(function(t){1==t.Status?alertify.success('<i class="far fa-comment-alt-times"></i> token # '+numberWithCommas(e.fcm_id)+" 已註銷"):alertify.error('<i class="far fa-exclamation-circle"></i> token # '+numberWithCommas(e.fcm_id)+" 註銷失敗")}):(alertify.error('<i class="far fa-exclamation-triangle"></i> 推播失敗<br>：'+JSON.stringify(i)),console.error(JSON.stringify(i)))}if(t){let l=a.nextAll("[data-bulk='"+a.attr("data-bulk")+"']").eq(0);console.log("* debug: "+l.length+"; data-sent_today: "+$(".recipients li[data-sent_today='0']").length),l.length>0?send_push(t,l):$(".recipients li[data-sent_today='0']").length<=1&&(get_sent_stats(),msg('<i class="far fa-comments-alt"></i> 推播群發完畢',"好耶",function(){$(window).scrollTop(0)}))}a.remove();let s=$(".result");s.children().slice(19).remove(),$("<ol>",{title:e.nickname,onclick:"$(this).fadeOut('fast');","data-username":e.username,"data-success":+(1==i.Status),html:$("<li>",{"data-device":e.device,text:e.username+" (#"+numberWithCommas(e.fcm_id)+")"}).add($("<li>",{text:e.title})).add($("<li>",{text:e.body})).add($("<li>",{title:e.url,text:"\uD83C\uDF10 "+e.url})).add($("<li>",{title:e.tag,text:"\uD83D\uDD16 "+e.tag}))}).prependTo(s).fadeIn()}).fail(function(e){if(alertify.error('<i class="far fa-exclamation-triangle"></i> 異常：'+JSON.stringify(e)),t){let i=a.nextAll("[data-bulk='"+a.attr("data-bulk")+"']").eq(0);console.log("* debug: "+i.length+"; data-sent_today: "+$(".recipients li[data-sent_today='0']").length),i.length>0?send_push(t,i):$(".recipients li[data-sent_today='0']").length<=1&&(get_sent_stats(),$("input[name='done_dingdong']:checked").length&&dingdong(),msg('<i class="far fa-comments-alt"></i> 推播群發完畢',"好耶",function(){$(window).scrollTop(0)}))}a.remove()})}function send_push_bulk(){let e=$(".recipients li[data-sent_today='0']"),t=e.length;t>0?(alertify.set({labels:{ok:"取消",cancel:'<i class="fas fa-inbox-out"></i> 確定群發'},buttonReverse:!1}),alertify.confirm('<i class="fal fa-comments-alt"></i> 即將推播至 '+t+"台裝置",function(t){t||(send_push(!0,e.odd().attr({"data-bulk":"odd"}).eq(0)),send_push(!0,e.even().attr({"data-bulk":"even"}).eq(0)))})):msg('<i class="far fa-exclamation-triangle"></i> 沒有可發送的裝置，請先行查詢')}function filter_finished(e){let t=$(".recipients");e?t.addClass("unfinished"):t.removeClass("unfinished")}function template_prefill(e){switch(e){case"greeting":hj_update({action:"alice_greeting"}).then(function(e){"greeting_title"in(e=e.Values)&&template_prefilling({title:"{{nickname}}晚安",body:"親愛的，"+e.greeting_title.trim(),url:"https://hearty.me/{{username}}?a={{username}}&link=bitly.com/3I8Kc7x",tag:"hj-greeting"})});break;case"vip_7":template_prefilling({title:"哈囉{{nickname}}",body:"謝謝你填寫知心小調查，7日 VIP 已送達你的溫度日記嚕~",url:"https://hearty.me/{{username}}?a={{username}}&link=bitly.com/33GVqRW",tag:"hj-billing"});break;case"vip_7-en":template_prefilling({title:"Hi {{nickname}}",body:"Received a 7-day VIP credit for the survey",url:"https://hearty.me/{{username}}?a={{username}}&link=bitly.com/33GVqRW",tag:"hj-billing"});break;case"response":template_prefilling({title:"嗨{{nickname}}",body:"已透過 Email回覆您的客服，請看信箱，並確認垃圾信 ( \xb4･ヮ･)ﾉ",url:"https://hearty.me/{{username}}?link=hearty.me/wv?o=go.hearty.me/hj-gmail",tag:"hj-cs"});break;case"response-en":template_prefilling({title:"Hi {{nickname}}",body:"Check email inbox for the reply ( \xb4･ヮ･)ﾉ",url:"https://hearty.me/{{username}}?link=hearty.me/wv?o=go.hearty.me/hj-gmail",tag:"hj-cs"});break;case"post_public":template_prefilling({title:"{{nickname}}",body:"你的公開日記已公開 ~ ◍•ᴗ•◍",url:"https://hearty.me/{{username}}?link=hearty.me/feed",tag:"hj-cs"});break;case"post_publish":template_prefilling({title:"{{nickname}}",body:"你的投稿日記已成功投稿，快到日記牆上看看吧！✧❛◡❛",url:"https://hearty.me/{{username}}?link=hearty.me/feed",tag:"hj-cs"});break;case"post_unqualified":template_prefilling({title:"系統提醒",body:"您的投稿日記遭檢舉，請遵守《投稿日記規範》呦 (;\xb4ㅁ`)=3",url:"https://hearty.me/{{username}}",tag:"hj-cs"});break;case"faq_penpal":template_prefilling({title:"{{nickname}}",body:"如何與筆友交換日記 (FAQ)",url:"https://hearty.me/{{username}}?link=faq.hearty.me/tutorial/penpal_diaries",tag:"hj-cs"});break;case"buyer_survey":template_prefilling({title:"{{nickname}}，溫度 VIP致謝",body:"1分鐘填寫滿意度調查",url:"https://hearty.me/{{username}}?link=www.surveycake.com/s/oVkmm?ssn0={{username}}",tag:"hj-survey"});break;case"unpaid_order":template_prefilling({title:"{{nickname}}",body:"小提醒：購買的 VIP尚未繳款唷",url:"https://hearty.me/{{username}}?link=hearty.me/shop/bill?o=HJ_"+new Date().getFullYear()+(getUrlPara("order_id")||"1").padStart(6,"0"),tag:"hj-order"})}}function template_prefilling(e){let t=$(".push_data");t.find("[data-title]").val(e.title),t.find("[data-body]").val(e.body),t.find("[data-url]").val(e.url),t.find("[data-tag] option").removeAttr("selected").filter("[value='"+e.tag+"']").attr("selected","")}function empty_recipients(){$(".recipients").slideUp("fast",function(){$(this).empty().show()})}function filter_recipients(e){$(".recipients li[data-device="+e+"]").slideUp("fast",function(){$(this).remove()})}function filter_all(e){let t=$(".user_data [data-uid_interval]");t.filter(":eq(0)").val(1).attr({max:e}),t.filter(":eq(1)").val(e).attr({max:e})}function uid_toggle(e,t){$(".user_data tr").attr("data-off","").filter(".uid_"+e).removeAttr("data-off"),alertify.success("<i class='fas fa-filter'></i> "+t+"模式")}function dingdong(){let e=new window.AudioContext,t=(t,a,i)=>{let n=e.createOscillator(),l=e.createGain();n.type="sine",n.frequency.value=t,l.gain.setValueAtTime(0,a),l.gain.linearRampToValueAtTime(.2,a+.05),l.gain.linearRampToValueAtTime(0,a+i),n.connect(l),l.connect(e.destination),n.start(a),n.stop(a+i)},a=e.currentTime;t(880,a,.4),t(660,a+.4,.6)}$(function(){get_sent_stats(),window.onbeforeunload=function(){return!1},$(document).scroll(function(){let e=$(".notify .page_up");$(this).scrollTop()>200?e.stop().fadeIn("slow"):e.stop().fadeOut("slow")}),getUrlPara("order_id")&&$("select[data-template]").val("unpaid_order").change()});