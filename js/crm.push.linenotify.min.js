"use strict";function hj_update__push(e){return $.ajax({url:location.href,type:"POST",dataType:"json",data:e,async:!0,timeout:1e4})}function get_sent_stats(){hj_update__push({action:"get_sent_stats"}).then(function(e){e=e.Values,$("[data-sent_stats]").text(e.date+" 午夜起，已寄給 "+numberWithCommas(e.users_sent||0)+"人，共 "+numberWithCommas(e.pushs_sent||0)+"則")})}function get_recipients(){let e=$(".recipients"),t=parseInt($("input[name='uid_selection']:checked").val()||0),a=$("input[data-uid_interval]").map(function(){return parseInt(this.value||1)}).get().sort(),n=$("textarea[data-uid_listed]").val().split(",").map(function(e){return parseInt(e.trim())||1}).sort();if(e.slideUp("fast"),$(".recipient_data .result").empty(),a[1]-a[0]>1e5){msg('<i class="far fa-exclamation-triangle"></i> 考量查詢量能，避免一次選擇超過 10萬位用戶');return}hj_loading(!0),hj_update__push({action:"get_recipients",uid_interval:0==t?JSON.stringify(a):"",uid_listed:1==t?JSON.stringify(n):""}).then(function(t){switch(t.Status){case 1:for(let a in t=t.Values,e.empty(),t){let n=t[a];for(let i in n.tokens){let s=n.username,l=parseInt(n.tokens[i].sent_today);$("<li>",{onclick:l>0?"alertify.error('* 略過寄送 #"+s+"')":"send_push(false,$(this))",title:s,"data-username":n.username,"data-nickname":n.nickname,"data-access_token":n.tokens[i].access_token,"data-device":5,"data-sent_today":l}).appendTo(e)}}e.slideDown("fast",function(){$("html, body").scrollTop(e.get(0).offsetTop-50)});break;case 2:e.show(),msg("<i class='far fa-exclamation-triangle'></i> 有資料漏填，或未選擇任何裝置")}}).fail(function(e){msg("<i class='far fa-exclamation-triangle'></i> 發生異常：<br>"+JSON.stringify(e))}).always(function(){hj_loading(!1)})}function send_push(e,t){if(e=e||!1,!(t=null==t?$(".recipients li[data-sent_today='0']:first"):t).length)return!1;let a=t.get(0).dataset,n=$(".push_data"),i={body:(n.find("[data-body]").val()||"").trim(),image:(n.find("[data-image]").val()||"").trim(),stickerid:parseInt(n.find("[data-stickerid]").val())||"",stickerid2:parseInt(n.find("[data-stickerid2]").val())||"",access_token:(a.access_token||"").trim(),username:(a.username||"").trim(),nickname:(a.nickname||"").trim()};if(i.body.length<4)return msg("<i class='far fa-exclamation-triangle'></i> 沒有填寫推播訊息"),!1;i.body=i.body.replace(/\{{username}}/g,i.username).replace(/\{{nickname}}/g,i.nickname),e?send_push_exec(i,e,t):(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-inbox-out'></i> 發送"},buttonReverse:!1}),alertify.confirm("<i class='far fa-comment-lines'></i> 即將推播予："+i.nickname+" ("+i.username+")",function(a){a||send_push_exec(i,e,t)}))}function send_push_exec(e,t,a){hj_update__push({action:"send_push",push:JSON.stringify(e)}).then(function(n){switch(n.Values,n.Status){case 1:console.log(JSON.stringify(n));break;case 3:alertify.error('<i class="fas fa-exclamation-triangle"></i> 略過重複寄發：'+e.username);break;case 4:alertify.error("<i class='far fa-comment-alt-times'></i> token 過期廢止");break;default:msg("<i class='far fa-exclamation-triangle'></i> 推播失敗<br>："+JSON.stringify(n))}if(t){let i=a.nextAll("[data-bulk='"+a.attr("data-bulk")+"']").eq(0);i.length>0?send_push(t,i):$(".recipients li[data-sent_today='0']").length||(get_sent_stats(),$("input[name='done_dingdong']:checked").length&&dingdong(),msg("<i class='far fa-comments-alt'></i> 批次推播完成","好耶",function(){$("html, body").scrollTop(0)}))}a.remove();let s=$(".result");s.children().slice(19).remove(),$("<ol>",{title:e.nickname,onclick:"$(this).fadeOut('fast')","data-username":e.username,"data-success":+(1==n.Status),html:$("<li>",{"data-device":5,text:e.username}).add($("<li>",{text:e.body}))}).prependTo(s).fadeIn()}).fail(function(e){msg("<i class='far fa-exclamation-triangle'></i> 發生異常：<br>"+JSON.stringify(e))})}function send_push_bulk(){let e=$(".recipients li[data-sent_today='0']"),t=e.length;t>0?(alertify.set({labels:{ok:"取消",cancel:"<i class='fas fa-inbox-out'></i> 確定群發"},buttonReverse:!1}),alertify.confirm("<i class='fal fa-comments-alt'></i> 即將推播至 "+t+"部用戶裝置",function(t){t||(send_push(!0,e.odd().attr({"data-bulk":"odd"}).eq(0)),send_push(!0,e.even().attr({"data-bulk":"even"}).eq(0)))})):msg('<i class="far fa-exclamation-triangle"></i> 沒有可發送的裝置，請先行查詢')}function filter_finished(e){let t=$(".recipients");e?t.addClass("unfinished"):t.removeClass("unfinished")}function empty_recipients(){$(".recipients").slideUp("fast",function(){$(this).empty().show()})}function filter_all(e){let t=$(".user_data [data-uid_interval]");t.filter(":eq(0)").val(1).attr({max:e}),t.filter(":eq(1)").val(e).attr({max:e})}function uid_toggle(e,t){$(".user_data tr").attr("data-off","").filter(".uid_"+e).removeAttr("data-off"),alertify.success("<i class='fas fa-filter'></i> "+t+"模式")}function dingdong(){let e=new window.AudioContext,t=(t,a,n)=>{let i=e.createOscillator(),s=e.createGain();i.type="sine",i.frequency.value=t,s.gain.setValueAtTime(0,a),s.gain.linearRampToValueAtTime(.2,a+.05),s.gain.linearRampToValueAtTime(0,a+n),i.connect(s),s.connect(e.destination),i.start(a),i.stop(a+n)},a=e.currentTime;t(880,a,.4),t(660,a+.4,.6)}$(function(){get_sent_stats(),window.onbeforeunload=function(){return!1},$(document).scroll(function(){let e=$(".notify .page_up");$(this).scrollTop()>200?e.stop().fadeIn("slow"):e.stop().fadeOut("slow")}),getUrlPara("order_id")&&$("select[data-template]").val("unpaid_order").change()});