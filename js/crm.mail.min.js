"use strict";function hj_preview(e,t){let a=$(".hj_preview");null!=t&&a.find("iframe").attr("srcdoc",t),e?a.slideDown("fast"):a.fadeOut("fast")}function get_templates(e){return $.getJSON("templates.json?v="+new Date().toISOString().slice(0,13).replace("T","-"),function(t){return null==e?t:e in t&&t[e]})}function get_template(e){get_templates(e).then(function(t){if(t&&e in t){t=t[e];let a=$(".push_data");a.find("[data-sender]").val(t.sender.name),a.find("[data-subject]").val(t.subject),a.find("[data-body]").val(t.body),a.find("[data-tag]").val(t.tag),$("select[name='list']").val(t.list)}})}function get_menu_templates(){get_templates().then(function(e){let t=$("select[data-templates]");for(let a in t.html($("<option>",{selected:""}).text("無")),e)$("<option>",{value:a,text:e[a].name,disabled:parseInt(e[a].format)>0}).appendTo(t)})}function save_template(e){$("<a>",{href:"data:"+(e||"text/plain")+";charset=utf-8,"+encodeURIComponent(tinymce.activeEditor.getContent()||""),download:"信件模板_"+new Date().toLocaleDateString("sv")+".html"}).get(0).click(),alertify.success('<i class="fas fa-arrow-to-bottom"></i> 開始下載')}function editor_init(){$(".push_data textarea[data-body]").tinymce({base_url:"https://cdn.jsdelivr.net/npm/tinymce@5.10.9",placeholder:"Email 內文",statusbar:!1,branding:!1,save_enablewhendirty:!1,skin:"oxide"+(window.matchMedia("(prefers-color-scheme: dark)").matches?"-dark":""),relative_urls:!1,remove_script_host:!1,height:300,menubar:!1,image_caption:!0,plugins:"autolink preview directionality code visualblocks visualchars fullscreen image link template codesample table charmap toc advlist wordcount imagetools textpattern noneditable charmap emoticons table paste save",toolbar:"code preview fullscreen | undo redo | formatselect bold underline alignjustify aligncenter alignright | forecolor backcolor removeformatk | table image link emoticons | fontsizeselect save",toolbar_drawer:"sliding",link_list:[{title:"溫度日記 首頁",value:"https://o.hearty.me"},{title:"溫度日記 用戶頁",value:"https://o.hearty.me/{{username}}"}],image_list:[{title:"溫度日記 Logo",value:"https://i.hearty.app/i/mailheader.png?o=1"},{title:"溫度日記 Sheara",value:"https://i.hearty.app/e/sheara.640.jpg?o=1"}],color_map:["ffffff","潔白","ffd1a4","皮膚","ffdcdc","淡粉","ffbdbd","淺粉","f16d6e","深紅","d78b7b","卡其","d28064","卡其","b4b4b4","淺灰","444444","深灰","000000","純黑"],contextmenu:"link",language:"zh_TW",language_url:"//cdn.jsdelivr.net/npm/tinymce-all-in-one@4.9.5/langs/zh_TW.min.js",default_link_target:"_blank",link_default_protocol:"https",paste_retain_style_properties:"all",paste_word_valid_elements:"*[*]",paste_convert_word_fake_lists:!1,paste_webkit_styles:"all",paste_merge_formats:!0,paste_data_images:!0,automatic_uploads:!0,images_upload_url:"../api/mail.img.php",images_upload_credentials:!0,save_onsavecallback:function(){save_template()}})}function richformat(){editor_init(),$("[data-sender_domain]").val("notify.heartymail.com").find("[data-plaintext]").prop("disabled",!0),$("select[data-templates] option").prop("disabled",!1)}function hj_update__push(e){return $.ajax({url:location.href,type:"POST",dataType:"json",data:e,async:!0,timeout:1e4})}function get_sent_stats(){hj_update__push({action:"get_sent_stats"}).then(function(e){e=e.Values,$("[data-sent_stats]").text(e.date+" 午夜起，已寄給 "+numberWithCommas(e.users_sent||0)+"人")})}function get_recipients(){let e=$(".recipients"),t=parseInt($("input[name='uid_selection']:checked").val()||0),a=$("input[data-uid_interval]").map(function(){return parseInt(this.value||1)}).get().sort(),i=$("textarea[data-uid_listed]").val().split(",").map(function(e){return parseInt(e.trim())||1}).sort();if(e.slideUp("fast"),$(".recipient_data .result").empty(),a[1]-a[0]>1e5){msg('<i class="far fa-exclamation-triangle"></i> 考量查詢量能，避免一次選擇超過 10萬位用戶');return}hj_loading(!0),hj_update__push({action:"get_recipients",uid_interval:0==t?JSON.stringify(a):"",uid_listed:1==t?JSON.stringify(i):"",email_verified:+!$("input[name='email_unverified']").is(":checked"),list:$("select[name='list']").val()||0,list_optin:$("input[name='list_optin']:checked").val()||0,lang:$("input[name='lang']:checked").val()||"",birthmonth:$("input[name='birthmonth']:checked").length,is_vip:$("input[name='is_vip']:checked").val()||0}).then(function(t){switch(t.Status){case 1:e.html(t.Values.map(function(e){let t=parseInt(e.sent_today),a=parseInt(e.email_verified);return $("<li>",{onclick:t>0?"alertify.error('* 略過寄送 "+e.username+"')":"send_mail(false,$(this))",title:"✉️ "+e.nickname+" ("+e.username+") "+(a>0?"✔":""),"data-user_id":e.user_id,"data-username":e.username,"data-nickname":e.nickname,"data-email":e.email,"data-email_verified":a,"data-sent_today":t})})).slideDown("fast",function(){$(window).scrollTop(e.get(0).offsetTop-50)});break;case 2:e.show(),msg('<i class="far fa-exclamation-triangle"></i> 有資料漏填');break;default:msg()}}).fail(function(e){msg('<i class="far fa-exclamation-triangle"></i> 喔不，<br>'+JSON.stringify(e))}).always(function(){hj_loading(!1)})}function send_mail(e,t){if(e=e||!1,!(t=null==t?$(".recipients li[data-sent_today='0']:first"):t).length)return!1;let a=t.get(0).dataset,i=$(".push_data"),n=(a.user_id||"").trim(),l=(a.username||"").trim(),s=(a.nickname||l||"").trim(),r=(a.email||"").trim(),o=i.find("[data-sender_domain]").val()||"notify.heartymail.com",c=(i.find("[data-subject]").val()||"").trim(),d={sender:{name:(i.find("[data-sender]").val()||"Hearty Journal 溫度日記").trim(),email:l+"@"+o,domain:o,list:$("select[name='list']").val()||0},recipient:{name:s,email:r,nickname:s,username:l},content:{subject:(i.find("[data-subject]").val()||"").trim(),body:(window.tinymce&&tinymce.activeEditor?tinymce.activeEditor.getContent():i.find("[data-body]").val()||"").trim(),tag:i.find("[data-tag]").val()||"",richformat:+i.find("input[name='format']").prop("checked")||0}},u=d.content;if(u.subject.length<4||u.body.length<6)return msg('<i class="far fa-exclamation-triangle"></i> 沒有填寫信件內容'),!1;d.content.subject=u.subject.replace(/\{{user_id}}/g,n).replace(/\{{username}}/g,l).replace(/\{{nickname}}/g,s).replace(/\{{email}}/g,r),d.content.body=u.body.replace(/\{{subject}}/g,c).replace(/\{{user_id}}/g,n).replace(/\{{username}}/g,l).replace(/\{{nickname}}/g,s).replace(/\{{email}}/g,r),e?send_mail_exec(d,e,t):(alertify.set({labels:{ok:"取消",cancel:'<i class="fas fa-inbox-out"></i> 寄信'},buttonReverse:!1}),alertify.confirm('<i class="fal fa-envelope-open-text"></i> 即將寄信給：'+s+" ("+l+")",function(a){a||send_mail_exec(d,e,t)}))}function send_mail_exec(e,t,a){let i=e.recipient.username,n=e.recipient.nickname;hj_update__push({action:"send_mail",mail:JSON.stringify(e)}).then(function(l){switch(l.Status){case 1:send_mail_log(e,"1FAIpQLSdn8CZP3i0xD5jL2SQ8Zj6d8h7yk9V-ReRKho54mPRuRX_g0g"),console.log(JSON.stringify(l));break;case 3:send_mail_log(e,"1FAIpQLSd1ktd9NEKxFAJBb8bG2HJwaOcs4VT6L0xUWEg7XGYmMMiW0A"),alertify.error('<i class="far fa-exclamation-triangle"></i> 略過重複寄發：'+n+" ("+i+")");break;default:alertify.error('<i class="far fa-exclamation-triangle"></i> 發信失敗：<br><b>'+i.substr(0,20)+"</b>"),console.error(l.Values)}t&&0==a.next().length&&(get_sent_stats(),$("input[name='done_dingdong']:checked").length&&dingdong(),msg('<i class="fal fa-envelope-open"></i> 批次群發完成',"好耶",function(){$(window).scrollTop(0)})),a.remove();let s=$(".result");s.children().slice(19).remove(),$("<ol>",{title:n,onclick:"hj_preview(true,$(this).data('html'))","data-username":i,"data-success":+(1==l.Status),html:$("<li>",{"data-device":""}).text(i).add($("<li>",{text:e.content.subject})).add($("<li>",{html:e.content.body}))}).data({html:e.content.body}).prependTo(s).fadeIn()}).fail(function(e){e=JSON.stringify(e),console.error(e),alertify.error('<i class="far fa-exclamation-triangle"></i> 糟了，<br>'+e.substr(0,20))})}function send_mail_bulk(){if(window.send_bulk){msg('<i class="fal fa-sync-alt"></i> 排程進行中，一次只能跑一組排程');return}let e=$(".recipients li[data-sent_today='0']").length;e>0?(alertify.set({labels:{ok:"取消",cancel:'<i class="fas fa-inbox-out"></i> 確定群發'},buttonReverse:!1}),alertify.confirm('<i class="fal fa-envelope-open-text"></i> 即將寄送至 '+e+"組 Emails",function(e){e||(window.send_bulk=setInterval(function(){let e=$(".recipients li[data-sent_today='0']");e.length,e.length>0?send_mail(!0,e.eq(0).attr("data-sent_today",1)):(clearInterval(send_bulk),window.send_bulk=null)},2e3))})):msg('<i class="far fa-exclamation-triangle"></i> 沒有可發信的 Email，請先行查詢')}function send_mail_log(e,t){gform_post(t,{emailAddress:e.recipient.email||"guest@hearty.me","entry.1244275016":e.recipient.username||"n/a","entry.912693507":e.recipient.nickname||"n/a","entry.1367122498":e.content.tag||"n/a","entry.2026927390":e.content.subject||"n/a","entry.1350707169":e.content.body||"n/a","entry.50475957":e.sender.domain||"n/a","entry.605239846":new Date((new Date).getTime()+288e5).toISOString().split("T")[0]})}function filter_finished(e){let t=$(".recipients");e?t.addClass("unfinished"):t.removeClass("unfinished")}function empty_recipients(){$(".recipients").slideUp("fast",function(){$(this).empty().show()})}function filter_recipients(e){$(".recipients li[data-email_verified="+e+"]").slideUp("fast",function(){$(this).remove()})}function filter_all(e){let t=$(".user_data [data-uid_interval]");t.filter(":eq(0)").val(1).attr({max:e}),t.filter(":eq(1)").val(e).attr({max:e})}function uid_toggle(e,t){$(".user_data tr").removeAttr("data-off").filter(".uid_"+("listed"==e?"interval":"listed")).attr("data-off",""),alertify.success('<i class="fas fa-filter"></i> '+t+"模式")}function dingdong(){let e=new window.AudioContext,t=(t,a,i)=>{let n=e.createOscillator(),l=e.createGain();n.type="sine",n.frequency.value=t,l.gain.setValueAtTime(0,a),l.gain.linearRampToValueAtTime(.2,a+.05),l.gain.linearRampToValueAtTime(0,a+i),n.connect(l),l.connect(e.destination),n.start(a),n.stop(a+i)},a=e.currentTime;t(880,a,.4),t(660,a+.4,.6)}$(function(){get_menu_templates(),get_sent_stats(),window.onbeforeunload=function(){return!1},$(document).on("scroll",function(){let e=$(".notify .page_up");$(this).scrollTop()>200?e.stop().fadeIn("slow"):e.stop().fadeOut("slow")})});